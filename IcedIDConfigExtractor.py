import sys
import os
import json
import struct
import string
import traceback
import time

from binaryninjaui import (UIAction, UIActionHandler, Menu)
from binaryninja import user_plugin_path, LowLevelILOperation
from binaryninja.highlevelil import HighLevelILInstruction
from binaryninja.function import Variable
from binaryninja.types import Symbol, SymbolType
from binaryninja import Transform
from binaryninja import BinaryReader, BinaryWriter, BinaryViewType

plugin_path = os.path.dirname(__file__)

def decrypt_config(bv):
    rc4 = Transform["RC4"]

    br = BinaryReader(bv)
    bw = BinaryWriter(bv)

    #read and decrypt config located in .data section
    dataSection = br.seek(0x403000)
    key = br.read(8)
    encryptedConfig = br.read(0x248)
    decryptedConfig = rc4.encode(encryptedConfig, {"key":key})

    #overwrite old .data section with decrypted config
    configSpecificAddr = 0x403008
    bw.seek(configSpecificAddr)
    bw.write(decryptedConfig)
    bv.save_auto_snapshot()

    print("[+] Decrypted Config!")
    print(decryptedConfig)
    print("[+] Also replaced the .data section with decrypted contents!")

def launch_plugin(context):
    bv = context.binaryView
    decrypt_config(bv)


UIAction.registerAction("IcedID Config Extractor")
UIActionHandler.globalActions().bindAction("IcedID Config Extractor", UIAction(launch_plugin))
Menu.mainMenu("Tools").addAction("IcedID Config Extractor", "IcedID Config Extractor")