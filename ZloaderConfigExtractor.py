import sys
import os
import json
import struct
import string
import traceback
import time

from binaryninjaui import (UIAction, UIActionHandler, Menu)
from binaryninja import user_plugin_path, LowLevelILOperation
from binaryninja.highlevelil import HighLevelILInstruction
from binaryninja.function import Variable
from binaryninja.types import Symbol, SymbolType
from binaryninja import Transform
from binaryninja import BinaryReader, BinaryWriter, BinaryViewType

plugin_path = os.path.dirname(__file__)

def decrypt_config(bv):
    rc4 = Transform["RC4"]

    br = BinaryReader(bv)
    bw = BinaryWriter(bv)

    #read and decrypt config located in .data section
    keyLocation = br.seek(0x6492f3)
    key = br.read(20)
    configLocation = 0x649004
    br.seek(configLocation)
    encryptedConfig = br.read(751)
    print(encryptedConfig)
    decryptedConfig = rc4.encode(encryptedConfig, {"key":key})

    #overwrite old .data section with decrypted config
    bw.seek(configLocation)
    bw.write(decryptedConfig)
    bv.save_auto_snapshot()

    print("[+] Decrypted Config!")
    print(decryptedConfig)
    print("[+] Also replaced the .data section with decrypted contents!")

def launch_plugin(context):
    bv = context.binaryView
    decrypt_config(bv)


UIAction.registerAction("Zloader Config Extractor")
UIActionHandler.globalActions().bindAction("Zloader Config Extractor", UIAction(launch_plugin))
Menu.mainMenu("Tools").addAction("Zloader Config Extractor", "Zloader Config Extractor")